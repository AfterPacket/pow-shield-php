# ==============================
# MINIMAL EXAMPLE.COM VHOSTS
# ONLY:
#  - PoW gate (cookie abp) with /__ab/pow.php + /__ab/pow-verify.php
#  - Rate-limit ONLY /__ab/* (optional include)
#  - Skip /status/ entirely
#  - Skip static assets
#  - Cloudflare-safe (does NOT block CF)
# ==============================


# --------------------------
# HTTP :80
# - redirect to https
# - but keep PoW rules here too (so direct :80 hits still behave)
# --------------------------
<VirtualHost *:80>
  ServerName example.com
  ServerAlias www.example.com

  DocumentRoot /var/www/example.com/public
  DirectoryIndex index.php index.html

  ErrorLog  ${APACHE_LOG_DIR}/example.com_error.log
  CustomLog ${APACHE_LOG_DIR}/example.com_access.log combined

  # (Example) env secret. Prefer real OS env / systemd for secrets.
  # SetEnv AB_POW_SECRET "LONG_RANDOM_SECRET_64+CHARS"

  RewriteEngine On

  # 0) Skip /status/ entirely (no PoW)
  RewriteRule ^status/ - [L]

  # 1) Skip the PoW endpoints themselves (prevents loops)
  RewriteRule ^__ab/ - [L]

  # 2) Only gate GET/HEAD
  RewriteCond %{REQUEST_METHOD} !^(GET|HEAD)$ [NC]
  RewriteRule ^ - [L]

  # 3) Skip common static assets
  RewriteRule \.(?:css|js|png|jpg|jpeg|gif|webp|svg|ico|woff2?|ttf|map)$ - [L,NC]

  # 4) If missing PoW pass cookie, redirect to challenge
  RewriteCond %{HTTP:Cookie} !(^|;\s*)abp= [NC]
  RewriteRule ^ /__ab/pow.php?next=%{REQUEST_URI}&qs=%{QUERY_STRING} [R=302,L,NE]

  # Force HTTPS
  RewriteRule ^ https://%{HTTP_HOST}%{REQUEST_URI} [R=301,L]
</VirtualHost>


# --------------------------
# HTTPS :443
# - main PoW enforcement
# --------------------------
<VirtualHost *:443>
  ServerName example.com
  ServerAlias www.example.com

  DocumentRoot /var/www/example.com/public
  DirectoryIndex index.php index.html

  ErrorLog  ${APACHE_LOG_DIR}/example.com_ssl_error.log
  CustomLog ${APACHE_LOG_DIR}/example.com_ssl_access.log combined

  SSLEngine on
  SSLCertificateFile    /etc/ssl/example.com/fullchain.pem
  SSLCertificateKeyFile /etc/ssl/example.com/privkey.pem
  SSLProtocol +TLSv1.2 +TLSv1.3

  # (Example) env secret. Prefer real OS env / systemd for secrets.
  # SetEnv AB_POW_SECRET "LONG_RANDOM_SECRET_64+CHARS"

  # Optional: include your rate-limit rules (ONLY for /__ab/*)
  # IncludeOptional /etc/modsecurity/ab_pow_ratelimit.conf
  # Header always set Retry-After "30" env=AB_RL

  # Basic safety headers (wonâ€™t break PoW)
  Header always set X-Content-Type-Options "nosniff"
  Header always set Referrer-Policy "no-referrer"
  Header always set Permissions-Policy "geolocation=(), microphone=(), camera=()"

  # PHP-FPM (example socket; replace with yours)
  <FilesMatch \.php$>
    SetHandler "proxy:unix:/run/php/php-fpm-example.sock|fcgi://localhost/"
  </FilesMatch>

  <Directory /var/www/example.com/public>
    Options -Indexes +SymLinksIfOwnerMatch
    AllowOverride All
    Require all granted
  </Directory>

  # Never cache /status/*
  <LocationMatch "^/status(/|$)">
    Header always set Cache-Control "no-store, no-cache, must-revalidate, max-age=0"
    Header always set Pragma "no-cache"
    Header always set Expires "0"
  </LocationMatch>

  RewriteEngine On

  # 0) Skip /status/ entirely (no PoW)
  RewriteRule ^status/ - [L]

  # 1) Skip the PoW endpoints themselves (prevents loops)
  RewriteRule ^__ab/ - [L]

  # 2) Only gate GET/HEAD
  RewriteCond %{REQUEST_METHOD} !^(GET|HEAD)$ [NC]
  RewriteRule ^ - [L]

  # 3) Skip common static assets
  RewriteRule \.(?:css|js|png|jpg|jpeg|gif|webp|svg|ico|woff2?|ttf|map)$ - [L,NC]

  # 4) If missing PoW pass cookie, redirect to challenge
  RewriteCond %{HTTP:Cookie} !(^|;\s*)abp= [NC]
  RewriteRule ^ /__ab/pow.php?next=%{REQUEST_URI}&qs=%{QUERY_STRING} [R=302,L,NE]

</VirtualHost>
