# --------------------------------------------------------------------
# Local Anti-bot PoW endpoint rate limit (Cloudflare-friendly)
# - Limits /__ab/pow.php and /__ab/pow-verify.php per real client IP
# - Uses CF-Connecting-IP when present; falls back to REMOTE_ADDR
# - Returns 429 Too Many Requests
# - Custom rule IDs: 1001000+ (avoid CRS conflicts)
# --------------------------------------------------------------------

SecRuleEngine On

# Prefer Cloudflare client IP if present and valid
SecRule REQUEST_HEADERS:CF-Connecting-IP "@rx ^[0-9a-fA-F\.:]+$" \
  "id:1001000,phase:1,pass,nolog,setvar:tx.ab_realip=%{MATCHED_VAR}"

# Fallback to REMOTE_ADDR if CF header missing
SecRule &TX:ab_realip "@eq 0" \
  "id:1001001,phase:1,pass,nolog,setvar:tx.ab_realip=%{REMOTE_ADDR}"

# -------------------------
# Rate limit: /__ab/pow.php
# Policy: max 60 hits / 60s / client IP
# -------------------------
SecRule REQUEST_URI "@beginsWith /__ab/pow.php" \
  "id:1001010,phase:1,pass,nolog,initcol:ip=%{tx.ab_realip},setvar:ip.ab_pow_hits=+1,expirevar:ip.ab_pow_hits=60"

SecRule REQUEST_URI "@beginsWith /__ab/pow.php" \
  "id:1001011,phase:1,deny,status:429,log,msg:'ab_pow_ratelimit: pow.php too many requests',chain"
  SecRule IP:ab_pow_hits "@gt 60"

# ------------------------------
# Rate limit: /__ab/pow-verify.php
# Policy: max 15 hits / 60s / client IP
# ------------------------------
SecRule REQUEST_URI "@beginsWith /__ab/pow-verify.php" \
  "id:1001020,phase:1,pass,nolog,initcol:ip=%{tx.ab_realip},setvar:ip.ab_verify_hits=+1,expirevar:ip.ab_verify_hits=60"

SecRule REQUEST_URI "@beginsWith /__ab/pow-verify.php" \
  "id:1001021,phase:1,deny,status:429,log,msg:'ab_pow_ratelimit: pow-verify too many requests',chain"
  SecRule IP:ab_verify_hits "@gt 15"
