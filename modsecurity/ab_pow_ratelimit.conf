# ModSecurity Rate Limiting for pow-shield-php
# Protects PoW endpoints from abuse
#
# This file should be included in your Apache config:
#   IncludeOptional /etc/modsecurity/ab_pow_ratelimit.conf
#

# ============================================================================
# Rate Limit: /__ab/pow.php (Challenge Page)
# ============================================================================
# Limit: 60 requests per minute per IP
# Action: Block with 429 for 60 seconds

<LocationMatch "^/__ab/pow\.php">
    # Initialize IP collection and counter
    SecAction \
        "id:910001,\
        phase:1,\
        pass,\
        nolog,\
        initcol:ip=%{REMOTE_ADDR},\
        setvar:ip.pow_requests=+1,\
        expirevar:ip.pow_requests=60"
    
    # Check if limit exceeded
    SecRule IP:POW_REQUESTS "@gt 60" \
        "id:910002,\
        phase:1,\
        deny,\
        status:429,\
        log,\
        msg:'PoW endpoint rate limit exceeded (pow.php)',\
        logdata:'IP: %{REMOTE_ADDR} - Requests: %{ip.pow_requests}',\
        setenv:AB_RL=1"
</LocationMatch>

# ============================================================================
# Rate Limit: /__ab/pow-verify.php (Verification Endpoint)
# ============================================================================
# Limit: 30 requests per minute per IP (stricter)
# Action: Block with 429 for 60 seconds

<LocationMatch "^/__ab/pow-verify\.php">
    # Initialize IP collection and counter
    SecAction \
        "id:910003,\
        phase:1,\
        pass,\
        nolog,\
        initcol:ip=%{REMOTE_ADDR},\
        setvar:ip.verify_requests=+1,\
        expirevar:ip.verify_requests=60"
    
    # Check if limit exceeded
    SecRule IP:VERIFY_REQUESTS "@gt 30" \
        "id:910004,\
        phase:1,\
        deny,\
        status:429,\
        log,\
        msg:'PoW verification rate limit exceeded (pow-verify.php)',\
        logdata:'IP: %{REMOTE_ADDR} - Requests: %{ip.verify_requests}',\
        setenv:AB_RL=1"
</LocationMatch>

# ============================================================================
# Optional: Set Retry-After header when rate limited
# ============================================================================
# Add this to your vhost config:
#   Header always set Retry-After "60" env=AB_RL
#
# Or enable it here (requires mod_headers):
#   <IfModule mod_headers.c>
#       Header always set Retry-After "60" env=AB_RL
#   </IfModule>
