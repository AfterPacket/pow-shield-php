#!/bin/bash
set -euo pipefail
umask 077

OUT="/etc/apache2/pow.env"
TMP="$(mktemp)"

GRACE_SECONDS="300"

# Pull current AB_POW_SECRET (if present) so we can shift it to _PREV
CURRENT=""
if [[ -f "$OUT" ]]; then
  CURRENT="$(awk -F'"' '/^[[:space:]]*SetEnv[[:space:]]+AB_POW_SECRET[[:space:]]+"/ {print $2; exit}' "$OUT" || true)"
fi

NEW="$(openssl rand -base64 64 | tr -d '\n')"

# Keep everything EXCEPT the lines we manage (so we don't overwrite user-added stuff)
FILTERED="$(mktemp)"
if [[ -f "$OUT" ]]; then
  grep -vE \
    '^[[:space:]]*# Managed by rotate-pow-secret\.sh[[:space:]]*$|^[[:space:]]*SetEnv[[:space:]]+AB_POW_SECRET(_PREV)?\b|^[[:space:]]*SetEnv[[:space:]]+AB_POW_GRACE\b' \
    "$OUT" > "$FILTERED" || true
else
  : > "$FILTERED"
fi

{
  echo "# Managed by rotate-pow-secret.sh"
  echo "SetEnv AB_POW_SECRET \"${NEW}\""
  if [[ -n "$CURRENT" ]]; then
    echo "SetEnv AB_POW_SECRET_PREV \"${CURRENT}\""
  fi
  echo "SetEnv AB_POW_GRACE ${GRACE_SECONDS}"
  echo
  cat "$FILTERED"
} > "$TMP"

rm -f "$FILTERED"

chown root:root "$TMP"
chmod 600 "$TMP"
mv -f "$TMP" "$OUT"

# Safety: verify Apache config first
apachectl -t

# Reload, not restart (keeps connections)
systemctl reload apache2
