#!/bin/bash
set -euo pipefail

OUT="/etc/apache2/pow.env"
TMP="$(mktemp)"
umask 077

CURRENT=""
if [[ -f "$OUT" ]]; then
  CURRENT="$(awk -F'"' '/SetEnv[[:space:]]+AB_POW_SECRET[[:space:]]+"/ {print $2; exit}' "$OUT" || true)"
fi

NEW="$(openssl rand -base64 64 | tr -d '\n')"

{
  echo '# Managed by rotate-pow-secret.sh'
  echo "SetEnv AB_POW_SECRET \"$NEW\""
  if [[ -n "${CURRENT}" ]]; then
    echo "SetEnv AB_POW_SECRET_PREV \"$CURRENT\""
  fi
} > "$TMP"

chown root:root "$TMP"
chmod 600 "$TMP"
mv -f "$TMP" "$OUT"

apachectl -t
systemctl reload apache2
